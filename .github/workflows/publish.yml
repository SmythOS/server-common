name: Build and Release

on:
    push:
        tags:
            - 'v*' # Triggers on tags like v1.0.0, v1.2.3, etc.
    workflow_dispatch: # Allows manual triggering for testing workflow only
        inputs:
            dry_run:
                description: 'Run validation without creating release'
                required: false
                default: 'true'
                type: boolean

jobs:
    # Validation job - runs on both tag push and manual trigger
    validate:
        runs-on: ubuntu-latest
        outputs:
            version: ${{ steps.get_version.outputs.version }}
            is_tag: ${{ steps.check_trigger.outputs.is_tag }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Fetch all history for proper git operations

            - name: Check trigger type
              id: check_trigger
              run: |
                  if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
                    echo "is_tag=true" >> $GITHUB_OUTPUT
                    echo "Triggered by tag push"
                  else
                    echo "is_tag=false" >> $GITHUB_OUTPUT
                    echo "Triggered manually - validation only"
                  fi

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Run linter
              run: npm run lint

            - name: Build project
              run: npm run build

            - name: Verify build artifacts exist
              run: |
                  echo "Checking for required build artifacts..."
                  if [ ! -d "dist" ]; then
                    echo "‚ùå Error: dist directory not found"
                    exit 1
                  fi
                  if [ ! -f "dist/index.js" ]; then
                    echo "‚ùå Error: dist/index.js not found"
                    exit 1
                  fi
                  if [ ! -d "dist/types" ]; then
                    echo "‚ùå Error: dist/types directory not found"
                    exit 1
                  fi
                  if [ ! -f "dist/types/index.d.ts" ]; then
                    echo "‚ùå Error: dist/types/index.d.ts not found"
                    exit 1
                  fi
                  echo "‚úÖ All build artifacts verified successfully"

            - name: Extract version from tag
              id: get_version
              run: |
                  if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
                    VERSION=${GITHUB_REF#refs/tags/v}
                    echo "version=$VERSION" >> $GITHUB_OUTPUT
                    echo "Extracted version from tag: $VERSION"
                  else
                    VERSION=$(node -p "require('./package.json').version")
                    echo "version=$VERSION" >> $GITHUB_OUTPUT
                    echo "Extracted version from package.json: $VERSION"
                  fi

            - name: Verify package.json version matches tag
              if: startsWith(github.ref, 'refs/tags/')
              run: |
                  PACKAGE_VERSION=$(node -p "require('./package.json').version")
                  TAG_VERSION="${{ steps.get_version.outputs.version }}"
                  echo "Package version: $PACKAGE_VERSION"
                  echo "Tag version: $TAG_VERSION"
                  if [ "$PACKAGE_VERSION" != "$TAG_VERSION" ]; then
                    echo "‚ùå Error: package.json version ($PACKAGE_VERSION) doesn't match tag version ($TAG_VERSION)"
                    echo "Please update package.json version to match the tag or create a new tag matching package.json"
                    exit 1
                  fi
                  echo "‚úÖ Version verification passed"

            - name: Verify package.json configuration
              run: |
                  echo "Verifying package.json configuration..."
                  # Check main entry point
                  MAIN=$(node -p "require('./package.json').main")
                  if [ "$MAIN" != "dist/index.js" ]; then
                    echo "‚ö†Ô∏è  Warning: main entry point is '$MAIN', expected 'dist/index.js'"
                  fi
                  # Check types entry point
                  TYPES=$(node -p "require('./package.json').types")
                  if [ "$TYPES" != "dist/types/index.d.ts" ]; then
                    echo "‚ö†Ô∏è  Warning: types entry point is '$TYPES', expected 'dist/types/index.d.ts'"
                  fi
                  # Check files array
                  FILES=$(node -p "JSON.stringify(require('./package.json').files || [])")
                  echo "Package includes files: $FILES"
                  echo "‚úÖ Package configuration verified"

    # Release job - only runs on tag push (not on manual trigger)
    release:
        needs: validate
        if: needs.validate.outputs.is_tag == 'true' && startsWith(github.ref, 'refs/tags/')
        runs-on: ubuntu-latest
        permissions:
            contents: write # Required to create releases and push to branches

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Configure Git
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

            - name: Update release branch
              run: |
                  TAG_NAME=${GITHUB_REF#refs/tags/}
                  echo "Updating release branch to tag: $TAG_NAME"

                  # Fetch all branches and tags
                  git fetch --all --tags

                  # Check if release branch exists on remote
                  if git ls-remote --heads origin release | grep -q release; then
                    echo "Release branch exists, checking it out..."
                    git checkout release
                    git pull origin release
                  else
                    echo "Creating new release branch..."
                    git checkout -b release
                  fi

                  # Reset to the tagged commit
                  echo "Resetting release branch to $TAG_NAME..."
                  git reset --hard $TAG_NAME

                  # Force push the release branch
                  echo "Pushing release branch..."
                  git push origin release --force

                  echo "‚úÖ Release branch updated successfully"

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  name: Release v${{ needs.validate.outputs.version }}
                  tag_name: ${{ github.ref_name }}
                  body: |
                      ## üöÄ Release v${{ needs.validate.outputs.version }}

                      ### üì¶ Installation

                      #### Option 1: Use release branch (auto-updates to latest release)

                      Add to your `package.json`:
                      ```json
                      {
                        "dependencies": {
                          "@smythos/server-common": "github:SmythOS/server-common#release"
                        }
                      }
                      ```

                      #### Option 2: Pin to specific version (recommended for production)

                      Add to your `package.json`:
                      ```json
                      {
                        "dependencies": {
                          "@smythos/server-common": "github:SmythOS/server-common#v${{ needs.validate.outputs.version }}"
                        }
                      }
                      ```

                      Then run:
                      ```bash
                      npm install
                      # or
                      pnpm install
                      # or
                      yarn install
                      ```

                      ### üîß How it works

                      - The package is built automatically during installation via the `prepublishOnly` script
                      - No pre-built artifacts are included in the repository
                      - TypeScript types are generated during the build process

                      ### üìã What's included

                      - ‚úÖ Build validated and verified
                      - ‚úÖ Linting passed
                      - ‚úÖ All type definitions generated
                      - ‚úÖ Source maps included

                      ---
                      *Generated automatically by GitHub Actions*
                  draft: false
                  prerelease: false
                  generate_release_notes: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
